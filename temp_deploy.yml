name: Deploy to Railway

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
    types: [ opened, synchronize, reopened, closed ]

jobs:
  build-and-deploy:
    if: (github.event_name == 'push') || (github.event_name == 'pull_request' && github.event.action != 'closed')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      
      - name: Get Version
        id: get_version
        run: |
          PR_NUMBER=${{ github.event.pull_request.number || 'main' }}
          SHA=$(git rev-parse --short HEAD)
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          echo "VERSION=v-${PR_NUMBER:-main}-${SHA}-${TIMESTAMP}" >> $GITHUB_ENV
          echo "VERSION_TAG=${{ env.VERSION }}" >> $GITHUB_OUTPUT
      
      # 前端映像建置和推送
      - name: Build and Push Frontend Image
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          # 禁用緩存，確保每次都使用最新代碼
          no-cache: true
          tags: |
            yunn0123/nail-it-frontend:latest
            yunn0123/nail-it-frontend:${{ env.VERSION }}
          build-args: |
            GITHUB_SHA=${{ github.sha }}
            VERSION=${{ env.VERSION }}
            ENVIRONMENT=${{ github.event_name == 'pull_request' && 'pr' || 'production' }}
            BUILD_DATE=$(date +%Y%m%d%H%M%S)
      
      # 後端映像建置和推送
      - name: Build and Push Backend Image
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          # 禁用緩存，確保每次都使用最新代碼
          no-cache: true
          tags: |
            yunn0123/nail-it-backend:latest
            yunn0123/nail-it-backend:${{ env.VERSION }}
          build-args: |
            GITHUB_SHA=${{ github.sha }}
            VERSION=${{ env.VERSION }}
            ENVIRONMENT=${{ github.event_name == 'pull_request' && 'pr' || 'production' }}
            BUILD_DATE=$(date +%Y%m%d%H%M%S)
      
      - name: Install Railway CLI
        run: npm install -g @railway/cli
      
      - name: Deploy to Railway
        run: |
          # 使用Railway CLI登入
          railway login --token ${{ secrets.RAILWAY_TOKEN }}
          
          # 設置項目和環境
          railway link -p debd9c55-da98-4f2e-9871-197b8b08220d
          
          # 添加卷（如果需要）
          if ! railway volume list | grep -q "uploads"; then
            railway volume add uploads --mountPath=/app/uploads
            echo "Created uploads volume"
          fi
          
          if ! railway volume list | grep -q "db-data"; then
            railway volume add db-data --mountPath=/data/db
            echo "Created db-data volume"
          fi
          
          # 設置環境變數 - 設置版本號和構建時間
          echo "Setting VERSION=${{ env.VERSION }}"
          railway variables set VERSION=${{ env.VERSION }}
          railway variables set BUILD_DATE=$(date +%Y%m%d%H%M%S)
          
          # 強制部署應用
          railway up --force
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
  
  cleanup-pr:
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Install Railway CLI
        run: npm install -g @railway/cli
      
      - name: Cleanup PR Environment
        run: |
          # 使用Railway CLI登入
          railway login --token ${{ secrets.RAILWAY_TOKEN }}
          
          PR_NUMBER=${{ github.event.pull_request.number }}
          echo "Cleaning up PR #${PR_NUMBER} environment"
          
          # 根據PR號碼刪除或清理環境 - 目前先註釋掉
          # railway environment delete pr-${PR_NUMBER}
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
